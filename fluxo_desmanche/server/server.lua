local Tunnel = module("vrp","lib/Tunnel")
local Proxy = module("vrp","lib/Proxy")
local vRP = Proxy.getInterface("vRP")

local blzr = {}
Tunnel.bindInterface("fluxo_desmanche", blzr)

-- Garantir que cfg está disponível
cfg = cfg or {}
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
-- PARA CONFIGURAR O VALOR QUE GANHA APÓS DESMANCHAR DETERMINADO VEÍCULO É NA CONFIG DA NATION_GARAGES. VC GANHA 10% DO VALOR QUE ESTÁ NA CONFIG DA NATION_GARAGES --
---------------------------------------------- CASO QUEIRA ALTERAR A PORCENTAGEM É NO SERVER DA NATION_GARAGES ------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
--////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

-- RETORNA VEICULOS PERMITIDOS DA NATION_GARAGES
function blzr.GetVehs()
    -- Importa a configuração da nation_garages
    local nationConfig = module("nation_garages", "config")
    local vehicleList = {}
    
    -- Extrai apenas os nomes dos veículos da lista da nation_garages
    if nationConfig and nationConfig.vehList then
        for i, veh in ipairs(nationConfig.vehList) do
            if veh.name and not veh.banido then -- Só adiciona veículos não banidos
                table.insert(vehicleList, veh.name)
            end
        end
    end
    
    return vehicleList
end



-- FUNÇÃO VERIFICAR PERMISSÃO DO DESMANCHE
function blzr.checkPerm(k)
    local source = source
    local user_id = vRP.getUserId(source)
    if not cfg.desmanche[k].server.restrito then
        return true
    end
    if #cfg.desmanche[k].server.permissions <= 0 then return true end 
    for k,v in pairs(cfg.desmanche[k].server.permissions) do
        if vRP.hasPermission(user_id,v) then
            return true 
        end
    end
    return false
end



-- FUNÇÃO PRA VERIFICAR SE POSSUI O ITEM
function blzr.checkItem(k)
    local source = source
    local user_id = vRP.getUserId(source)
    if #cfg.desmanche[k].server.itens > 0 then
        for k,v in pairs(cfg.desmanche[k].server.itens) do
            if vRP.getInventoryItemAmount(user_id, v[1]) < v[2] then 
                return false
            end
        end
        for k,v in pairs(cfg.desmanche[k].server.itens) do 
            vRP.tryGetInventoryItem(user_id,v[1],v[2])
        end
        return true
    end
    return true
end


RegisterServerEvent("fluxo:desmancharVeiculo")
AddEventHandler("fluxo:desmancharVeiculo", function(placa, nome, modelo, webhook)
    -- Função desabilitada - Usando nation_garages/desmancheVehicles2 diretamente
    -- local source = source
    -- local user_id = vRP.getUserId(source)
    
    -- -- Valor base (você pode ajustar conforme necessário)
    -- local valor = 10000
    
    -- -- Adicionar dinheiro sujo ao inventário
    -- TriggerEvent("Inventory:addItem", user_id, "item", "dinheirosujo", valor, true)
    
    -- -- Notificar o jogador
    -- TriggerClientEvent("Notify", source, "sucesso", "Você recebeu R$"..valor.." em dinheiro sujo pela venda do veículo.")
    
    -- -- Log para o Discord (opcional)
    -- if webhook then
    --     PerformHttpRequest(webhook, function(err, text, headers) end, 'POST', json.encode({
    --         embeds = {{
    --             title = "Desmanche de Veículo",
    --             description = "**ID:** "..user_id.."\n**Placa:** "..placa.."\n**Modelo:** "..modelo.."\n**Valor:** R$"..valor,
    --             color = 65280
    --         }}
    --     }), { ['Content-Type'] = 'application/json' })
    -- end
end)
